<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <title>Refraktometer-Rechner</title>
    <meta name="description" content="Refraktometer Berechnungen und Messwertkorrektur für Hobbybrauer">
    <meta name="keywords" content="Refraktometer, Refraktometer-Korrektur, Bier, Brauen, Hobbybrauer">
    <meta name="author" content="Thomas Ascher">   
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.css">
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.js"></script>
</head>

<body>
    <script>
        // Copyright (c) 2021 Thomas Ascher
        // Licensed under the terms of the MIT license
        // https://www.brewersfriend.com/plato-to-sg-conversion-chart/
        function sgToPlato(sg) {
            return (-1.0 * 616.868) + (1111.14 * sg) - (630.272 * Math.pow(sg, 2)) + (135.997 * Math.pow(sg, 3));
        }

        // https://www.brewersfriend.com/plato-to-sg-conversion-chart/
        function platoToSG(plato) {
            return 1.0 + (plato / (258.6 - ((plato / 258.2) * 227.1)));
        }

        // Novotny, Pocitame: Nova korekce refraktometru, http://www.diversity.beer/2017/01/pocitame-nova-korekce-refraktometru.html     
        function correctNovotnyQuadratic(initialBrix, finalBrix) {
            return 1.335 * Math.pow(10.0, -5) * Math.pow(initialBrix, 2) -
                3.239 * Math.pow(10.0, -5) * initialBrix * finalBrix +
                2.916 * Math.pow(10.0, -5) * Math.pow(finalBrix, 2) -
                2.421 * Math.pow(10.0, -3) * initialBrix +
                6.219 * Math.pow(10.0, -3) * finalBrix + 1.0;
        }

        // Novotny, Pocitame: Nova korekce refraktometru, http://www.diversity.beer/2017/01/pocitame-nova-korekce-refraktometru.html
        function correctNovotnyLinear(initialBrix, finalBrix) {
            return -0.002349 * initialBrix + 0.006276 * finalBrix + 1.0;
        }

        // Terrill, Refractometer FG Results, http://seanterrill.com/2011/04/07/refractometer-fg-results/
        function correctTerrillCubic(initialBrix, finalBrix) {
            return 1.0 - 0.0044993 * initialBrix + 0.000275806 * Math.pow(initialBrix, 2) -
                0.00000727999 * Math.pow(initialBrix, 3) + 0.0117741 * finalBrix -
                0.00127169 * Math.pow(finalBrix, 2) + 0.0000632929 * Math.pow(finalBrix, 3);
        }

        // Terrill, Refractometer FG Results, http://seanterrill.com/2011/04/07/refractometer-fg-results/
        function correctTerrillLinear(initialBrix, finalBrix) {
            return 1.0 - 0.000856829 * initialBrix + 0.00349412 * finalBrix;
        }

        // Bonham, The Use of Handheld Refractometers by Homebrewers, Zymurgy January/February 2001 p. 44
        function correctBonham(initialBrix, finalBrixWort) {
            return 1.001843 - 0.002318474 * initialBrix - 0.000007775 * Math.pow(initialBrix, 2) -
            0.000000034 * Math.pow(initialBrix, 3) + 0.00574 * finalBrixWort +
                0.00003344 * Math.pow(finalBrixWort, 2) + 0.000000086 * Math.pow(finalBrixWort, 3);
        }

        // Bonham, The Use of Handheld Refractometers by Homebrewers, Zymurgy January/February 2001 p. 44
        function correctGardner(initialBrix, finalBrixWort) {
            return platoToSG(1.53 * finalBrixWort - 0.59 * initialBrix);
        }

        function correct(correctionIndex, initialBrix, finalBrix, finalBrixWort) {
            switch (correctionIndex) {
                case 0:
                    return correctTerrillCubic(initialBrix, finalBrix);
                case 1:
                    return correctTerrillLinear(initialBrix, finalBrix);
                case 2:
                    return correctNovotnyQuadratic(initialBrix, finalBrix);
                case 3:
                    return correctNovotnyLinear(initialBrix, finalBrix);
                case 4:
                    return correctBonham(initialBrix, finalBrixWort);
                case 5:
                default:
                    return correctGardner(initialBrix, finalBrixWort);
            }
        }

        // Novotny, Revisiting ABV Calculations, Zymurgy July/August 2019 p. 47
        function calcREBalling(ogPlato, aePlato) {
            return 0.1808 * ogPlato + 0.8192 * aePlato;
        }

        // Novotny, Revisiting ABV Calculations, Zymurgy July/August 2019 p. 48
        function calcABVNovotny(og, fg) {
            return fg * (5118.0 * (Math.pow(og, 2) - Math.pow(fg, 2)) + 16755.0 * (fg - og)) / (8.739 * Math.pow(og, 4)
                - 57.22 * Math.pow(og, 3) + 89.09 * Math.pow(og, 2) + 14.95 + og - 105.99)
        }

        // Novotny, Revisiting ABV Calculations, Zymurgy July/August 2019 p. 46
        function calcABWFromABV(abv, fg) {
            return abv * 0.791 / fg;
        }
        
        // Hall, Brew by the Numbers, Zymurgy Summer 1995 p. 57
        function calcAttenuation(ogPlato, sgPlato) {
            return (ogPlato - sgPlato) * 100.0 / ogPlato;
        }

        // Hall, Brew by the Numbers, Zymurgy Summer 1995 p. 59
        function calcCaloriesPer100ML(og, fg) {
            return (3621.0 * fg * ((0.8114 * fg + 0.1886 * og - 1.0) + 0.53 * (og - fg) / (1.775 - og))) / 354.8812 * 100.0;
        }

        function kcalToJoule(kcal) {
            return kcal * 4185.8;
        }

        class Result {
            constructor() {
                this.ogPlato = NaN;
                this.fgPlato = NaN;
                this.rePlato = NaN;
                this.abv = NaN;
                this.abw = NaN;
                this.attFG = NaN;
                this.attRE = NaN;
                this.cal = NaN;
                this.calkj = NaN;
            }
        }

        function isNumeric(str) {
            if (typeof str != "string")
                return false;  
            return !isNaN(str) && !isNaN(parseFloat(str))
        }

        function calc(correctionIndex, initialBrixWort, finalBrixWort, wortCor) {
            var hasInitialBrixWort = isNumeric(initialBrixWort);
            var hasFinalBrixWort = isNumeric(finalBrixWort);
            var hasWortCor = isNumeric(wortCor);

            var result = new Result();
            if (hasInitialBrixWort && hasWortCor) {
                result.ogPlato = initialBrixWort / wortCor;
                if (hasFinalBrixWort) {
                    var finalBrix = finalBrixWort / wortCor;
                    var fg = correct(correctionIndex, result.ogPlato, finalBrix, finalBrixWort);
                    var og = platoToSG(result.ogPlato);
                    result.fgPlato = sgToPlato(fg);
                    result.rePlato = calcREBalling(result.ogPlato, result.fgPlato);
                    result.abv = calcABVNovotny(og, fg);
                    result.abw = calcABWFromABV(result.abv, fg);
                    result.attFG = calcAttenuation(result.ogPlato, result.fgPlato);
                    result.attRE = calcAttenuation(result.ogPlato, result.rePlato);
                    result.cal = calcCaloriesPer100ML(og, fg);
                    result.calkj = kcalToJoule(result.cal) / 1000.0;
                }
            };
            return result;
        }

        function textify(value, unit) {
            const POST_COMMA_DIGITS = 2;
            if (isNaN(value)) {
                return "-";
            } else {
                return value.toFixed(POST_COMMA_DIGITS) + " " + unit;
            }
        }

        function updateTable(result) {
            $('#ogoutput').html(textify(result.ogPlato, "°P"));
            $('#fgoutput').html(textify(result.fgPlato, "°P"));
            $('#reoutput').html(textify(result.rePlato, "°P"));
            $('#abvoutput').html(textify(result.abv, "Vol.-%") + " / " + textify(result.abw, "Masse-%"));
            $('#attfgoutput').html(textify(result.attFG, "%"));
            $('#attreoutput').html(textify(result.attRE, "%"));
            $('#caloutput').html(textify(result.calkj, "kJ") + " / " + textify(result.cal, "kcal"));
        }

        function updateResult() {
            var result = calc(
                $('#formselect').prop('selectedIndex'),
                $('#initialinput').val(),
                $('#finalinput').val(),
                $('#wortcorinput').val());
            updateTable(result);
        }

        $(document).ready(function() {
            $('#btncalc').click(function() {
                updateResult();
            });
            updateTable(new Result());
        });
    </script>
    <div data-role="page">
        <div data-role="header">
            <h1>Refraktometer-Rechner</h1>
        </div>
        <div role="main" class="ui-content">
            <form>
                <label for="formselect">Berechnungsmodell:</label>
                <select name="formselect" id="formselect">
                    <option value="0">Terrill Kubisch</option>
                    <option value="1">Terrill Linear</option>
                    <option value="2">Novotny Quadratisch</option>
                    <option value="3">Novotny Linear</option>
                    <option value="4">Bonham</option>
                    <option value="5">Gardner</option>
                </select>
                <label for="initialinput">Refraktometerwert Anstellwürze (°Brix):</label>
                <input type="number" name="initialinput" id="initialinput" value="" step="0.1" />
                <label for="finalinput">Refraktometerwert Jungbier (°Brix):</label>
                <input type="number" name="finalinput" id="finalinput" value="" step="0.1" />
                <label for="wortcorinput">Würze-Korrekturfaktor:</label>
                <input type="number" name="wortcorinput" id="wortcorinput" value="1.04" step="0.01" />
            </form>
            <button name="btncalc" id="btncalc">Berechnen</button>
            <table>
                <tbody>
                    <tr>
                        <td>Alkoholgehalt:</th>
                        <td id="abvoutput"></td>
                    </tr>
                    <tr>
                        <td>Stammwürze:</th>
                        <td id="ogoutput"></td>
                    </tr>
                    <tr>
                        <td>Scheinbarer Restextrakt:</th>
                        <td id="fgoutput"></td>
                    </tr>
                    <tr>
                        <td>Scheinbarer Vergärungsgrad:</th>
                        <td id="attfgoutput"></td>
                    </tr>
                    <tr>
                        <td>Tatsächlicher Restextrakt:</th>
                        <td id="reoutput"></td>
                    </tr>
                    <tr>
                        <td>Tatsächlicher Vergärungsgrad:</th>
                        <td id="attreoutput"></td>
                    </tr>
                    <tr>
                        <td>Nährwert je 100 ml:</th>
                        <td id="caloutput"></td>
                    </tr>                                                          
                </tbody>
            </table>
        </div>
    </div>
</body>

</html>