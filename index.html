<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <title>Refraktometer-Rechner</title>
    <meta name="description" content="Refraktometer Berechnungen und Messwertkorrektur für Hobbybrauer">
    <meta name="keywords" content="Refraktometer, Refraktometer-Korrektur, Bier, Brauen, Hobbybrauer">
    <meta name="author" content="Thomas Ascher">   
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="jquery.mobile-1.4.2.min.css">
    <script src="jquery-1.10.2.min.js"></script>
    <script src="jquery.mobile-1.4.2.min.js"></script>
</head>

<body>
    <script>
        // Copyright (c) 2021 Thomas Ascher
        // Licensed under the terms of the MIT license
        // https://www.brewersfriend.com/plato-to-sg-conversion-chart/
        function sgToPlato(sg) {
            return (-1.0 * 616.868) + (1111.14 * sg) - (630.272 * Math.pow(sg, 2)) + (135.997 * Math.pow(sg, 3));
        }

        // https://www.brewersfriend.com/plato-to-sg-conversion-chart/
        function platoToSG(plato) {
            return 1.0 + (plato / (258.6 - ((plato / 258.2) * 227.1)));
        }

        // Novotny, Pocitame: Nova korekce refraktometru, http://www.diversity.beer/2017/01/pocitame-nova-korekce-refraktometru.html     
        function correctNovotnyQuadratic(initialBrix, finalBrix, wortFactor) {
            initialBrix /= wortFactor;
            finalBrix /= wortFactor;
            return 1.335 * Math.pow(10.0, -5) * Math.pow(initialBrix, 2) -
                3.239 * Math.pow(10.0, -5) * initialBrix * finalBrix +
                2.916 * Math.pow(10.0, -5) * Math.pow(finalBrix, 2) -
                2.421 * Math.pow(10.0, -3) * initialBrix +
                6.219 * Math.pow(10.0, -3) * finalBrix + 1.0;
        }

        // Novotny, Pocitame: Nova korekce refraktometru, http://www.diversity.beer/2017/01/pocitame-nova-korekce-refraktometru.html
        function correctNovotnyLinear(initialBrix, finalBrix, wortFactor) {
            initialBrix /= wortFactor;
            finalBrix /= wortFactor;            
            return -0.002349 * initialBrix + 0.006276 * finalBrix + 1.0;
        }

        // Terrill, Refractometer FG Results, http://seanterrill.com/2011/04/07/refractometer-fg-results/
        function correctTerrillCubic(initialBrix, finalBrix, wortFactor) {
            initialBrix /= wortFactor;
            finalBrix /= wortFactor;            
            return 1.0 - 0.0044993 * initialBrix + 0.000275806 * Math.pow(initialBrix, 2) -
                0.00000727999 * Math.pow(initialBrix, 3) + 0.0117741 * finalBrix -
                0.00127169 * Math.pow(finalBrix, 2) + 0.0000632929 * Math.pow(finalBrix, 3);
        }

        // Terrill, Refractometer FG Results, http://seanterrill.com/2011/04/07/refractometer-fg-results/
        function correctTerrillLinear(initialBrix, finalBrix, wortFactor) {
            initialBrix /= wortFactor;
            finalBrix /= wortFactor;            
            return 1.0 - 0.000856829 * initialBrix + 0.00349412 * finalBrix;
        }

        // Bonham, The Use of Handheld Refractometers by Homebrewers, Zymurgy January/February 2001 p. 44
        function correctBonham(initialBrix, finalBrix, wortFactor) {
            initialBrix /= wortFactor;
            return 1.001843 - 0.002318474 * initialBrix - 0.000007775 * Math.pow(initialBrix, 2) -
            0.000000034 * Math.pow(initialBrix, 3) + 0.00574 * finalBrix +
                0.00003344 * Math.pow(finalBrix, 2) + 0.000000086 * Math.pow(finalBrix, 3);
        }

        // Bonham, The Use of Handheld Refractometers by Homebrewers, Zymurgy January/February 2001 p. 44
        function correctGardner(initialBrix, finalBrix, wortFactor) {
            initialBrix /= wortFactor;
            return platoToSG(1.53 * finalBrix - 0.59 * initialBrix);
        }

        function correct(modelIndex, initialBrix, finalBrix, wortFactor) {
            switch (modelIndex) {
                case 0:
                    return correctTerrillCubic(initialBrix, finalBrix, wortFactor);
                case 1:
                    return correctTerrillLinear(initialBrix, finalBrix, wortFactor);
                case 2:
                    return correctNovotnyQuadratic(initialBrix, finalBrix, wortFactor);
                case 3:
                    return correctNovotnyLinear(initialBrix, finalBrix, wortFactor);
                case 4:
                    return correctBonham(initialBrix, finalBrix, wortFactor);
                case 5:
                default:
                    return correctGardner(initialBrix, finalBrix, wortFactor);
            }
        }

        // Novotny, Revisiting ABV Calculations, Zymurgy July/August 2019 p. 47
        function calcREBalling(oe, ae) {
            return 0.1808 * oe + 0.8192 * ae;
        }

        // Novotny, Revisiting ABV Calculations, Zymurgy July/August 2019 p. 48
        function calcABVNovotny(og, fg) {
            return fg * (5118.0 * (Math.pow(og, 2) - Math.pow(fg, 2)) + 16755.0 * (fg - og)) / (8.739 * Math.pow(og, 4)
                - 57.22 * Math.pow(og, 3) + 89.09 * Math.pow(og, 2) + 14.95 + og - 105.99)
        }

        // Novotny, Revisiting ABV Calculations, Zymurgy July/August 2019 p. 46
        function calcABWFromABV(abv, fg) {
            return abv * 0.791 / fg;
        }
        
        // Hall, Brew by the Numbers, Zymurgy Summer 1995 p. 57
        function calcAttenuation(oe, re) {
            return (oe - re) * 100.0 / oe;
        }

        // Hall, Brew by the Numbers, Zymurgy Summer 1995 p. 59
        function calcCaloriesPer100ML(og, fg) {
            return (3621.0 * fg * ((0.8114 * fg + 0.1886 * og - 1.0) + 0.53 * (og - fg) / (1.775 - og))) / 354.8812 * 100.0;
        }

        function kcalToJoule(kcal) {
            return kcal * 4185.8;
        }

        class Result {
            constructor() {
                this.oe = NaN;
                this.ae = NaN;
                this.re = NaN;
                this.abv = NaN;
                this.abw = NaN;
                this.attFG = NaN;
                this.attRE = NaN;
                this.cal = NaN;
                this.calkj = NaN;
            }
        }

        function isNumeric(str) {
            if (typeof str != "string")
                return false;  
            return !isNaN(str) && !isNaN(parseFloat(str))
        }

        class Input {
            constructor() {
                this.modelIndex = 0;
                this.initialBrix = "";
                this.finalBrix = "";
                this.wortFactor = "";
            }

            hasInitialInput() {
                return isNumeric(this.initialBrix) && isNumeric(this.wortFactor);
            }

            hasFinalInput() {
                return isNumeric(this.finalBrix) && isNumeric(this.wortFactor);
            }
        }

        function calc(input) {
            var result = new Result();
            if (input.hasInitialInput()) {
                result.oe = input.initialBrix / input.wortFactor;
                if (input.hasFinalInput()) {
                    var fg = correct(input.modelIndex, input.initialBrix, input.finalBrix, input.wortFactor);
                    var og = platoToSG(result.oe);
                    result.ae = sgToPlato(fg);
                    result.re = calcREBalling(result.oe, result.ae);
                    result.abv = calcABVNovotny(og, fg);
                    result.abw = calcABWFromABV(result.abv, fg);
                    result.attFG = calcAttenuation(result.oe, result.ae);
                    result.attRE = calcAttenuation(result.oe, result.re);
                    result.cal = calcCaloriesPer100ML(og, fg);
                    result.calkj = kcalToJoule(result.cal) / 1000.0;
                }
            };
            return result;
        }

        function textify(value, unit) {
            const POST_COMMA_DIGITS = 2;
            if (isNaN(value)) {
                return "-";
            } else {
                return value.toFixed(POST_COMMA_DIGITS) + " " + unit;
            }
        }

        function updateTable(result) {
            $('#ogoutput').html(textify(result.oe, "°P"));
            $('#fgoutput').html(textify(result.ae, "°P"));
            $('#reoutput').html(textify(result.re, "°P"));
            $('#abvoutput').html(textify(result.abv, "vol %") + " / " + textify(result.abw, "%"));
            $('#attfgoutput').html(textify(result.attFG, "%"));
            $('#attreoutput').html(textify(result.attRE, "%"));
            $('#caloutput').html(textify(result.calkj, "kJ") + " / " + textify(result.cal, "kcal"));
        }

        function getInput() {
            var input = new Input();
            input.modelIndex = $('#formselect').prop('selectedIndex');
            input.initialBrix = $('#initialinput').val();
            input.finalBrix = $('#finalinput').val();
            input.wortFactor = $('#wortfactorinput').val();
            return input;
        }

        function updateResult() {
            var input = getInput();
            var result = calc(input);
            updateTable(result);
        }

        $(document).ready(function() {
            $('#btncalc').click(function() {
                updateResult();
            });
            updateTable(new Result());
        });

        $(window).unload(function() {
            alert('Handler for .unload() called.');
        });


    </script>
    <div data-role="page">
        <div data-role="header">
            <h1>Refraktometer-Rechner</h1>
        </div>
        <div role="main" class="ui-content">
            <form>
                <label for="formselect">Berechnungsmodell:</label>
                <select name="formselect" id="formselect">
                    <option value="0">Terrill Kubisch</option>
                    <option value="1">Terrill Linear</option>
                    <option value="2">Novotny Quadratisch</option>
                    <option value="3">Novotny Linear</option>
                    <option value="4">Bonham / Stan­dard</option>
                    <option value="5">Gardner</option>
                </select>
                <label for="initialinput">Refraktometerwert Anstellwürze (°Brix):</label>
                <input type="number" name="initialinput" id="initialinput" value="" step="0.1" />
                <label for="finalinput">Refraktometerwert Jungbier (°Brix):</label>
                <input type="number" name="finalinput" id="finalinput" value="" step="0.1" />
                <label for="wortfactorinput">Würze-Korrekturfaktor:</label>
                <input type="number" name="wortfactorinput" id="wortfactorinput" value="1.04" step="0.01" />
            </form>
            <button name="btncalc" id="btncalc">Berechnen</button>
            <table>
                <tbody>
                    <tr>
                        <td>Alkoholgehalt:</td>
                        <td id="abvoutput"></td>
                    </tr>
                    <tr>
                        <td>Stammwürze:</td>
                        <td id="ogoutput"></td>
                    </tr>
                    <tr>
                        <td>Scheinbarer Restextrakt:</td>
                        <td id="fgoutput"></td>
                    </tr>
                    <tr>
                        <td>Scheinbarer Vergärungsgrad:</td>
                        <td id="attfgoutput"></td>
                    </tr>
                    <tr>
                        <td>Tatsächlicher Restextrakt:</td>
                        <td id="reoutput"></td>
                    </tr>
                    <tr>
                        <td>Tatsächlicher Vergärungsgrad:</td>
                        <td id="attreoutput"></td>
                    </tr>
                    <tr>
                        <td>Nährwert je 100 ml:</td>
                        <td id="caloutput"></td>
                    </tr>                                                          
                </tbody>
            </table>
        </div>
    </div>
</body>

</html>